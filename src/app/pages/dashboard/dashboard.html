<section class="page">
  <div class="head">
    <div>
      <h1>Market Dashboard</h1>
      <p class="muted">
        Suivi temps r√©el : <span style="color:var(--crypto-color)">Crypto</span> & <span style="color:var(--stock-color)">Stocks</span>
      </p>
    </div>

    <div class="head-actions">
      <div class="pill">{{ (count$ | async) ?? 0 }} actifs</div>
      <button class="btn" type="button" (click)="reset()">Reset All</button>
    </div>
  </div>
  
  <div class="tabs" *ngIf="activeTab$ | async as active">
    <button class="tab-btn" [class.active]="active === 'ALL'" (click)="setTab('ALL')">Global</button>
    <button class="tab-btn" [class.active]="active === 'CRYPTO'" (click)="setTab('CRYPTO')">Cryptos</button>
    <button class="tab-btn" [class.active]="active === 'STOCK'" (click)="setTab('STOCK')">Stocks</button>
    <button class="tab-btn" [class.active]="active === 'FOREX'" (click)="setTab('FOREX')">Forex</button>
    <button class="tab-btn stats-tab" [class.active]="active === 'STATS'" (click)="setTab('STATS')">
      üìä Stats & Perf
    </button>
  </div>

  <ng-container *ngIf="(activeTab$ | async) === 'STATS'">
    <div class="stats-container" *ngIf="stats$ | async as s">
      
      <div class="kpi-grid">
        <div class="stat-card win">
          <div class="lbl">üèÜ Top Winner</div>
          <div class="val" *ngIf="s.topGainer">
            {{ s.topGainer.symbol }}
            <span class="pct">+{{ s.topGainer.changePct | number:'1.2-2' }}%</span>
          </div>
          <div class="sub" *ngIf="s.topGainer">{{ s.topGainer.price | number:'1.2-5' }} $</div>
          <div class="muted" *ngIf="!s.topGainer">‚Äî</div>
        </div>

        <div class="stat-card loss">
          <div class="lbl">üìâ Top Loser</div>
          <div class="val" *ngIf="s.topLoser">
            {{ s.topLoser.symbol }}
            <span class="pct">{{ s.topLoser.changePct | number:'1.2-2' }}%</span>
          </div>
          <div class="sub" *ngIf="s.topLoser">{{ s.topLoser.price | number:'1.2-5' }} $</div>
          <div class="muted" *ngIf="!s.topLoser">‚Äî</div>
        </div>

        <div class="stat-card avg">
          <div class="lbl">‚öñÔ∏è Moyenne Globale</div>
          <div class="val" [class.pos]="s.avgChange >= 0" [class.neg]="s.avgChange < 0">
            {{ s.avgChange > 0 ? '+' : ''}}{{ s.avgChange | number:'1.2-2' }}%
          </div>
          <div class="sub">Sur {{ s.totalCount }} actifs</div>
        </div>
      </div>

      <div class="card distribution-card">
        <h2>Allocation du Portefeuille</h2>
        <div class="dist-bar">
          <div 
            class="segment" 
            *ngFor="let d of s.distribution" 
            [style.width.%]="d.pct" 
            [style.background]="d.color"
            [title]="d.type + ': ' + (d.pct | number:'1.0-1') + '%'"
          ></div>
        </div>
        <div class="dist-legend">
          <div class="leg-item" *ngFor="let d of s.distribution">
            <span class="dot" [style.background]="d.color"></span>
            <span class="type">{{ d.type }}</span>
            <span class="count">{{ d.count }} ({{ d.pct | number:'1.0-0' }}%)</span>
          </div>
        </div>
      </div>

    </div>
  </ng-container>

  <ng-container *ngIf="(activeTab$ | async) !== 'STATS'">
    <div class="card controls">
      <div class="row">
        <label>
          <span class="lbl">Rechercher</span>
          <input class="inp" [formControl]="queryCtrl" placeholder="ex: BTC..." />
        </label>

        <label>
          <span class="lbl">Min Variation %</span>
          <input class="inp" type="number" [formControl]="minChangeCtrl" placeholder="0.00" />
        </label>

        <label>
          <span class="lbl">Trier par</span>
          <select class="inp" [formControl]="sortByCtrl">
            <option value="addedAt">R√©cents</option>
            <option value="symbol">Symbole (A-Z)</option>
            <option value="changePct">Performance</option>
          </select>
        </label>

        <label>
          <span class="lbl">Ordre</span>
          <select class="inp" [formControl]="sortDirCtrl">
            <option value="desc">Descendant ‚¨á</option>
            <option value="asc">Ascendant ‚¨Ü</option>
          </select>
        </label>
      </div>

      <hr />

      <div class="add-row">
        <label class="grow relative">
          <span class="lbl">Ajouter un actif</span>
          <input class="inp" [formControl]="addCtrl" (keydown.enter)="add()" placeholder="Tapez un symbole (ex: AAPL, ETHUSDT)..." />

          <div class="suggestions" *ngIf="addSuggestions$ | async as s">
            <button
              class="suggestion"
              *ngFor="let it of s"
              type="button"
              (click)="pickSuggestion(it.symbol)"
            >
              <strong>{{ it.symbol }}</strong>
              <span class="muted">{{ it.description }}</span>
            </button>
          </div>
        </label>

        <button class="btn" type="button" (click)="add()">Ajouter +</button>
      </div>
    </div>

    <div class="grid">
      <div class="card fill-h">
        <h2 *ngIf="activeTab$ | async as active">
          {{ active === 'ALL' ? 'Vue Globale' : '' }}
          {{ active === 'CRYPTO' ? 'Portefeuille Crypto' : '' }}
          {{ active === 'STOCK' ? 'Actions & ETFs' : '' }}
          {{ active === 'FOREX' ? 'March√© des Devises' : '' }}
        </h2>

        <div class="muted" style="text-align:center; margin-top: 2rem;" *ngIf="(vm$ | async)?.length === 0">
          Aucun actif dans cette cat√©gorie.
        </div>

        <ul class="list" *ngIf="vm$ | async as items">
          <li *ngFor="let it of items" class="item">
            <a class="sym" [routerLink]="['/symbol', it.symbol]">
              {{ it.symbol }}
              <span class="tag" [class.crypto]="it.type === 'CRYPTO'">{{ it.type }}</span>
            </a>

            <span class="price">
            <ng-container *ngIf="it.price > 0; else noPrice">
               {{ it.price | number:(it.type === 'CRYPTO' && it.price < 1 ? '1.4-8' : '1.2-2') }} $
            </ng-container>
            <ng-template #noPrice>
              <span class="muted" style="font-size: 0.9rem; opacity: 0.5;">‚Äî</span>
            </ng-template>
          </span>

            <span class="chg" [class.pos]="it.changePct >= 0" [class.neg]="it.changePct < 0">
              {{ it.changePct >= 0 ? '+' : '' }}{{ it.changePct | number:'1.2-2' }}%
            </span>
            
            <span class="time muted" title="Derni√®re maj">
              {{ it.ts | date:'HH:mm:ss' }}
            </span>
            
            <span class="source-badge" title="Source: {{ it.source }}">
              {{ it.source === 'BINANCE' ? '‚ö°' : '‚òÅÔ∏è' }}
            </span>

            <button class="btn-icon" title="Retirer" (click)="store.removeSymbol(it.symbol)">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </ng-container>
</section>