<div class="page">
  <header class="head">
    <div class="title">
      <h1>Dashboard</h1>
      <p class="subtitle">
        Watchlist live via Store RxJS (combineLatest / switchMap / retry / shareReplay).
        <span class="muted">Refresh effectif = anti rate-limit (si token).</span>
      </p>
    </div>

    <div class="pills">
      <span class="pill">watchlist: <b>{{ watchlistCount$ | async }}</b></span>
      <span class="pill">refresh: <b>{{ refreshLabel$ | async }}</b></span>
      <button class="btn ghost" type="button" (click)="resetAll()">Reset</button>
    </div>
  </header>

  <section class="card controls">
    <div class="grid">
      <label class="field">
        <span>Recherche</span>
        <input class="input" [formControl]="searchCtrl" placeholder="AAPL, TSLA, MSFT..." />
      </label>

      <label class="field">
        <span>Min change %</span>
        <input class="input" type="number" step="0.1" [formControl]="minChangeCtrl" placeholder="ex: 0.5" />
      </label>

      <label class="field">
        <span>Tri</span>
        <select class="input" [formControl]="sortByCtrl">
          <option value="addedAt">Ajout</option>
          <option value="symbol">Symbole</option>
          <option value="changePct">% Change</option>
        </select>
      </label>

      <label class="field">
        <span>Sens</span>
        <select class="input" [formControl]="sortDirCtrl">
          <option value="desc">Desc</option>
          <option value="asc">Asc</option>
        </select>
      </label>
    </div>

    <div class="add">
      <label class="field grow">
        <span>Ajouter (typeahead Finnhub)</span>
        <input class="input" [formControl]="addCtrl" placeholder="ex: NVDA" (keydown.enter)="addSymbol()" />
      </label>

      <button class="btn" type="button" (click)="addSymbol()">Add</button>
    </div>

    <div class="suggestions" *ngIf="(suggestions$ | async) as sug">
      <div class="sug" *ngIf="sug.length > 0">
        <button class="sugItem" type="button" *ngFor="let s of sug" (click)="pickSuggestion(s)">
          <b>{{ s.symbol }}</b>
          <span class="muted">{{ s.description }}</span>
        </button>
      </div>
    </div>
  </section>

  <section class="bottom">
    <div class="card">
      <h2>Watchlist (live)</h2>

      <div class="empty" *ngIf="(rows$ | async)?.length === 0">
        Rien pour l’instant.

        <div class="muted" *ngIf="filters$ | async as f" style="margin-top:8px;">
          <b>Filtres actifs:</b>
          query="{{ f.query }}" • minChangePct="{{ f.minChangePct ?? 'null' }}"
        </div>

        <div class="muted" style="margin-top:8px;">
          ➜ Clique sur <b>Reset</b> ou vide <b>Min change %</b> / <b>Recherche</b>.
        </div>
      </div>

      <ul class="list" *ngIf="rows$ | async as rows">
        <li class="row" *ngFor="let r of rows">
          <a class="sym" [routerLink]="['/symbol', r.symbol]">{{ r.symbol }}</a>

          <span class="price" [class.na]="r.priceDisplay === '—'">{{ r.priceDisplay }}</span>

          <span class="chg" [class.pos]="r.isUp" [class.neg]="r.isDown">{{ r.chgDisplay }}</span>

          <span class="ts" [class.stale]="r.isStale">{{ r.updatedLabel }}</span>

          <button class="icon" type="button" title="Remove" (click)="remove(r.symbol)">×</button>
        </li>
      </ul>

      <p class="hint">
        Si tu vois “—”, c’est souvent token invalide / rate-limit / marché fermé (pas d’updates).
      </p>
    </div>

    <div class="card">
      <h2>State (debug)</h2>
      <pre class="json">{{ (debug$ | async) | json }}</pre>
    </div>
  </section>
</div>
