<section class="page" *ngIf="symbol$ | async as sym">
  <div class="head">
    <div>
      <h1>
        <span class="pill">{{ sym }}</span>
        <span class="muted"> — details</span>
      </h1>

      <div class="muted" *ngIf="profile$ | async as p">
        <span *ngIf="p?.name"><strong>{{ p.name }}</strong></span>
        <span *ngIf="p?.exchange"> • {{ p.exchange }}</span>
        <span *ngIf="p?.finnhubIndustry"> • {{ p.finnhubIndustry }}</span>
      </div>
    </div>

    <div class="actions">
      <a class="btn ghost" routerLink="/dashboard">← Dashboard</a>

      <ng-container *ngIf="inWatchlist$ | async as inWl">
        <button class="btn" *ngIf="!inWl" type="button" (click)="addToWatchlist(sym)">+ Watchlist</button>
        <button class="btn danger" *ngIf="inWl" type="button" (click)="removeFromWatchlist(sym)">Remove</button>
      </ng-container>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Quote (live)</h2>

      <ng-container *ngIf="quote$ | async as q; else noQuote">
        <div class="price">
          {{ isFiniteNumber(q.c) ? (q.c | number:'1.2-2') : '—' }}
        </div>

        <div class="chg"
             [class.pos]="isFiniteNumber(q.dp) && q.dp >= 0"
             [class.neg]="isFiniteNumber(q.dp) && q.dp < 0">
          {{ isFiniteNumber(q.dp) && q.dp >= 0 ? '+' : '' }}{{ isFiniteNumber(q.dp) ? (q.dp | number:'1.2-2') : '—' }}%
          <span class="muted"> ({{ isFiniteNumber(q.d) ? (q.d | number:'1.2-2') : '—' }})</span>
        </div>

        <div class="muted mini">O {{ q.o }} • H {{ q.h }} • L {{ q.l }} • Prev {{ q.pc }}</div>
      </ng-container>

      <ng-template #noQuote>
        <div class="muted">Chargement...</div>
      </ng-template>
    </div>

    <div class="card wide">
      <div class="row">
        <h2>Chart</h2>

        <div class="controls">
          <label>
            <span class="lbl">Resolution</span>
            <select class="inp" [formControl]="resolutionCtrl">
              <option value="5">5m</option>
              <option value="15">15m</option>
              <option value="30">30m</option>
              <option value="60">1h</option>
              <option value="D">1D</option>
            </select>
          </label>

          <label>
            <span class="lbl">Days</span>
            <input class="inp" type="number" [formControl]="daysCtrl" />
          </label>
        </div>
      </div>

      <div class="chart-container" *ngIf="chartSeries$ | async as series">
        <apx-chart
          *ngIf="series.length > 0; else noData"
          [series]="series"
          [chart]="chartOptions.chart!"
          [xaxis]="chartOptions.xaxis!"
          [yaxis]="chartOptions.yaxis!"
          [title]="chartOptions.title!"
          [theme]="chartOptions.theme!"
        ></apx-chart>
        
        <ng-template #noData>
          <div class="muted" style="padding: 2rem; text-align: center;">
            Pas de données pour cette période.
          </div>
        </ng-template>
      </div>
    </div>

    <div class="card" *ngIf="metrics$ | async as m">
      <h2>Key Statistics</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="label">Market Cap (M)</span>
          <span class="value">{{ m.metric.marketCapitalization | number:'1.0-0' }} $</span>
        </div>
        <div class="stat-item">
          <span class="label">P/E Ratio</span>
          <span class="value">{{ m.metric.peRatio | number:'1.2-2' }}</span>
        </div>
        <div class="stat-item">
          <span class="label">Div. Yield</span>
          <span class="value text-green">{{ m.metric.dividendYield | number:'1.2-2' }}%</span>
        </div>
        <div class="stat-item">
          <span class="label">52W High</span>
          <span class="value">{{ m.metric['52WeekHigh'] | number:'1.2-2' }}</span>
        </div>
        <div class="stat-item">
          <span class="label">Beta</span>
          <span class="value">{{ m.metric.beta | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <div class="card wide">
      <h2>Dernières Actualités</h2>
      
      <div class="muted" *ngIf="(news$ | async)?.length === 0" style="padding: 1rem;">
        Aucune news récente disponible pour ce titre.
      </div>

      <div class="news-grid" *ngIf="news$ | async as items">
        <a class="news-card" *ngFor="let it of items" [href]="it.url" target="_blank" rel="noopener">
          <div class="news-img" *ngIf="it.image">
            <img [src]="it.image" alt="news thumb" loading="lazy">
          </div>
          
          <div class="news-content">
            <div class="news-meta">
              <span class="source">{{ it.source }}</span>
              <span class="date">{{ (it.datetime * 1000) | date:'short' }}</span>
            </div>
            <h3 class="headline">{{ it.headline }}</h3>
          </div>
        </a>
      </div>
    </div>
  </div>
</section>